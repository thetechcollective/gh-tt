
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Ready
# This workflow is triggered by 'ready' branches 

on:
  workflow_dispatch:
  push:
    branches: 
      - 'ready/*'

permissions:
  contents: write
  issues: write

jobs:

  mark-pending:
    name: Statuses
    permissions:
      statuses: write
    uses: lakruzz/workflows/.github/workflows/mark_pending.yml@experimental
    with:
      statuses: |
        Pytest + cov
        Ruff
        Cspell
        E2E in testbed

  pytest_with_coverage:
    name: Unit testing
    needs: mark-pending
    permissions:
      statuses: write
    uses: lakruzz/workflows/.github/workflows/pytest_with_coverage.yml@experimental
    with:
      context: Pytest + cov

  ruff_formatting:
    name: Linting
    needs: mark-pending
    permissions:
      statuses: write
    uses: lakruzz/workflows/.github/workflows/ruff_check.yml@experimental
    with:
      context: Ruff

  cspel_check:
    name: Spelling
    needs: mark-pending
    permissions:
      statuses: write
    uses: lakruzz/workflows/.github/workflows/cspell_check.yml@experimental
    with:
      context: Cspell



  pytest_integration:
    name: Integration testing
    needs: mark-pending
    permissions:
      statuses: write
    # continue-on-error: true # <- This doesn't work in reusable workflows, so we set it in the integration_test.yml
    secrets: inherit
    uses: ./.github/workflows/integration_test.yml
    with:
      context: E2E in testbed


  fast-forward-merge:
    name: Merge
    needs:
      - ruff_formatting
      - pytest_with_coverage
      - pytest_integration
    permissions:
      contents: write
    secrets:
      READY_PUSHER: ${{ secrets.READY_PUSHER }}
    uses: lakruzz/workflows/.github/workflows/fast_forward.yml@experimental
    with:
      target_branch: main #default is main
      user_name: "GitHub Action: ready" #required 
      user_email: "tt-ready@thetechcollective.eu" # required

  close_issue:
    needs: fast-forward-merge
    permissions:
      issues: write
      contents: write
    uses: lakruzz/workflows/.github/workflows/close_issue.yml@experimental
    with:
      user_name: "GitHub Action: ready" #required 
      user_email: "tt-ready@thetechcollective.eu" # required
      delete_issue_branch: true # default is true
      delete_ready_branch: true # default is true


# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Issue branch push
# This workflow is triggered on push to branches that begins with a number (issue-branches)

on:
  workflow_dispatch:
  merge_group:
  push:
    branches: 
      - '[0-9]*'

# No special permissions defined before we need them
permissions:
  contents: read

env:
  PYTHON_VERSIONS: "['3.12', '3.13', '3.14']"

jobs:

  # It is not possible to pass an environment variable down to
  # a reusable workflow as an argument via _with_.
  # See: https://stackoverflow.com/a/73305536
  # The workaround is to put the environment variable as a step output.
  python_versions:
    runs-on: ubuntu-latest
    outputs:
      python_versions: ${{ steps.step1.outputs.python_versions }}
    steps:
      - id: step1
        run: echo "python_versions=$PYTHON_VERSIONS" >> "$GITHUB_OUTPUT"

  pytest_with_coverage:
    name: Unit testing
    needs: python_versions
    permissions:
      statuses: write
      contents: read
    uses: thetechcollective/workflows/.github/workflows/checking_python_pytest_matrix.yaml@stable
    with:
      context: Unit testing w/ coverage
      pytest_arguments: "--cov=. --cov-config=.coveragerc -m unittest"
      python_versions: ${{ needs.python_versions.outputs.python_versions }}
      uv-sync-args: '' # override the default and pass nothing

  pytest_hypothesis:
    name: Property-based testing
    needs: python_versions
    permissions: 
      statuses: write
      contents: read
    uses: thetechcollective/workflows/.github/workflows/checking_python_pytest_matrix.yaml@stable
    with:
      context: Property-based testing
      pytest_arguments: "-m hypothesis --hypothesis-profile=1000"
      python_versions: ${{ needs.python_versions.outputs.python_versions }}
      uv-sync-args: '' # override the default and pass nothing

  ruff_linting:
    name: Linting
    permissions:
      statuses: write
      contents: read
    uses: thetechcollective/workflows/.github/workflows/checking_python_ruff_lint.yaml@stable
    with:
      context: Ruff
      uv-sync-args: '' # override the default and pass nothing

  ruff_formatting:
    name: Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          # Latest python compliant with the project's requires-python
          python-version-file: 'pyproject.toml'
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
            # Latest uv compliant with the project's tool.uv required version
            version-file: 'pyproject.toml'

      - run: |
            uv run --frozen -- ruff format --check


  cspel_check:
    name: Spelling
    permissions:
      statuses: write
      contents: read
    uses: thetechcollective/workflows/.github/workflows/checking_cspell_check.yaml@stable
    with:
      context: Cspell

  pytest_end_to_end:
    name: End to end testing
    permissions:
      statuses: write
    secrets: inherit
    uses: ./.github/workflows/end_to_end_test.yml

  check:  # This job does nothing and is only used for the branch protection
    name: âœ… All tests passed
    if: always()

    needs:
    - ruff_linting
    - ruff_formatting
    - cspel_check
    - pytest_end_to_end
    - pytest_hypothesis
    - pytest_with_coverage

    runs-on: ubuntu-latest

    timeout-minutes: 1

    steps:
    - name: Decide whether the needed jobs succeeded or failed
      uses: re-actors/alls-green@release/v1
      with:
        jobs: ${{ toJSON(needs) }}
